<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Simple - Horarios Forn Verge</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .admin-header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .employee-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .shift-btn {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .shift-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .shift-morning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            border-color: #f59e0b;
        }
        .shift-afternoon {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #1d4ed8;
        }
        .shift-free {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border-color: #4b5563;
        }
        .save-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Header -->
    <header class="admin-header text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Panel Simple de Horarios</h1>
                        <p class="text-green-200">Semana 9-15 Febrero 2025</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-green-200">Estado</p>
                        <p class="text-sm font-semibold" id="status">Listo</p>
                    </div>
                    <button id="saveAll" class="save-btn">
                        <i class="fas fa-save mr-2"></i>Guardar Todo
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Instructions -->
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-r-lg">
            <div class="flex items-start space-x-3">
                <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
                <div>
                    <h3 class="font-semibold text-blue-800">Instrucciones Simples</h3>
                    <p class="text-blue-700 mt-1">
                        <strong>üåÖ Ma√±ana:</strong> 7:00-14:00 (7h) ‚Ä¢ 
                        <strong>üåÜ Tarde:</strong> 14:00-21:00 (7h) ‚Ä¢ 
                        <strong>üÜì Libre:</strong> D√≠a de descanso
                    </p>
                    <p class="text-blue-700 mt-1 text-sm">
                        Haz click en las opciones para cada empleado y d√≠a. Luego click en "Guardar Todo".
                    </p>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12 hidden">
            <div class="loading">
                <i class="fas fa-spinner fa-spin text-4xl text-green-500 mb-4"></i>
                <p class="text-gray-600">Cargando empleados...</p>
            </div>
        </div>

        <!-- Employees Grid -->
        <div id="employeesGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- Se genera din√°micamente -->
        </div>

        <!-- Save Status -->
        <div id="saveStatus" class="fixed bottom-6 right-6 hidden">
            <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
                <i class="fas fa-check mr-2"></i>
                <span>Horarios guardados correctamente</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n
        const SUPABASE_URL = 'https://csxgkxjeifakwslamglc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzeGdreGplaWZha3dzbGFtZ2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjM4NjIsImV4cCI6MjA2NDg5OTg2Mn0.iGDmQJGRjsldPGmXLO5PFiaLOk7P3Rpr0omF3b8SJkg';
        const WEEK_START = '2025-02-09';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Configuraci√≥n de d√≠as y turnos
        const DAYS = [
            { key: 'lunes', name: 'Lun 9' },
            { key: 'martes', name: 'Mar 10' },
            { key: 'miercoles', name: 'Mi√© 11' },
            { key: 'jueves', name: 'Jue 12' },
            { key: 'viernes', name: 'Vie 13' },
            { key: 'sabado', name: 'S√°b 14' },
            { key: 'domingo', name: 'Dom 15' }
        ];

        const SHIFTS = {
            morning: {
                name: 'üåÖ Ma√±ana',
                time: '7:00-14:00',
                start: '07:00:00',
                end: '14:00:00',
                hours: 7,
                class: 'shift-morning'
            },
            afternoon: {
                name: 'üåÜ Tarde', 
                time: '14:00-21:00',
                start: '14:00:00',
                end: '21:00:00',
                hours: 7,
                class: 'shift-afternoon'
            },
            free: {
                name: 'üÜì Libre',
                time: 'Descanso',
                start: null,
                end: null,
                hours: 0,
                class: 'shift-free'
            }
        };

        // Variables globales
        let employees = [];
        let scheduleData = {};

        // ================================
        // FUNCIONES PRINCIPALES
        // ================================

        async function initApp() {
            console.log('üöÄ Inicializando Panel Simple...');
            updateStatus('Cargando...');
            showLoading();
            
            await loadEmployees();
            await loadCurrentSchedules();
            renderEmployees();
            setupEventListeners();
            
            hideLoading();
            updateStatus('Listo');
        }

        function setupEventListeners() {
            document.getElementById('saveAll').addEventListener('click', saveAllSchedules);
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('employeesGrid').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('employeesGrid').classList.remove('hidden');
        }

        // ================================
        // GESTI√ìN DE DATOS
        // ================================

        async function loadEmployees() {
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .neq('role', 'admin')
                    .order('name');

                if (error) {
                    console.error('‚ùå Error cargando empleados:', error);
                    return;
                }

                employees = data;
                console.log('‚úÖ Empleados cargados:', employees.length);
                
                // Inicializar estructura de horarios
                employees.forEach(emp => {
                    scheduleData[emp.id] = {};
                    DAYS.forEach(day => {
                        scheduleData[emp.id][day.key] = 'free'; // Por defecto libre
                    });
                });

            } catch (error) {
                console.error('‚ùå Error general:', error);
            }
        }

        async function loadCurrentSchedules() {
            try {
                const { data, error } = await supabase
                    .from('schedules')
                    .select('*')
                    .eq('week_start', WEEK_START);

                if (error) {
                    console.error('‚ùå Error cargando horarios:', error);
                    return;
                }

                // Procesar horarios existentes
                data.forEach(schedule => {
                    const empId = schedule.employee_id;
                    const day = schedule.day_of_week;
                    
                    if (scheduleData[empId]) {
                        if (schedule.is_free_day) {
                            scheduleData[empId][day] = 'free';
                        } else if (schedule.start_time === '07:00:00') {
                            scheduleData[empId][day] = 'morning';
                        } else if (schedule.start_time === '14:00:00') {
                            scheduleData[empId][day] = 'afternoon';
                        }
                    }
                });

                console.log('‚úÖ Horarios actuales cargados');

            } catch (error) {
                console.error('‚ùå Error cargando horarios:', error);
            }
        }

        // ================================
        // RENDERIZADO UI
        // ================================

        function renderEmployees() {
            const grid = document.getElementById('employeesGrid');
            grid.innerHTML = '';

            employees.forEach(employee => {
                const card = document.createElement('div');
                card.className = 'employee-card p-6';
                card.innerHTML = `
                    <div class="flex items-center mb-6">
                        <div class="text-4xl mr-4">${employee.emoji}</div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${employee.name}</h3>
                            <p class="text-gray-600">@${employee.employee_id}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-2">
                        ${DAYS.map(day => renderDayColumn(employee.id, day)).join('')}
                    </div>
                `;
                
                grid.appendChild(card);
            });

            // Agregar event listeners
            setupShiftEventListeners();
        }

        function renderDayColumn(empId, day) {
            const currentShift = scheduleData[empId][day.key] || 'free';
            
            return `
                <div class="text-center">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">${day.name}</h4>
                    <div class="space-y-2">
                        ${Object.keys(SHIFTS).map(shiftKey => 
                            renderShiftOption(empId, day.key, shiftKey, currentShift === shiftKey)
                        ).join('')}
                    </div>
                </div>
            `;
        }

        function renderShiftOption(empId, day, shiftKey, isSelected) {
            const shift = SHIFTS[shiftKey];
            const selectedClass = isSelected ? shift.class : 'bg-gray-100 hover:bg-gray-200';
            
            return `
                <div 
                    class="shift-btn ${selectedClass}" 
                    data-emp="${empId}" 
                    data-day="${day}" 
                    data-shift="${shiftKey}"
                    title="${shift.name} - ${shift.time}"
                >
                    <div class="text-lg mb-1">${shift.name.split(' ')[0]}</div>
                    <div class="text-xs font-medium">${shift.time}</div>
                </div>
            `;
        }

        function setupShiftEventListeners() {
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const empId = e.currentTarget.dataset.emp;
                    const day = e.currentTarget.dataset.day;
                    const shift = e.currentTarget.dataset.shift;
                    
                    // Actualizar datos
                    scheduleData[empId][day] = shift;
                    
                    // Re-renderizar solo esta columna
                    renderEmployees();
                });
            });
        }

        // ================================
        // GUARDAR DATOS
        // ================================

        async function saveAllSchedules() {
            const saveBtn = document.getElementById('saveAll');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
            saveBtn.disabled = true;
            updateStatus('Guardando...');

            try {
                // Primero eliminar horarios existentes de esta semana
                await supabase
                    .from('schedules')
                    .delete()
                    .eq('week_start', WEEK_START);

                // Preparar nuevos horarios
                const newSchedules = [];
                
                employees.forEach(employee => {
                    DAYS.forEach(day => {
                        const shiftKey = scheduleData[employee.id][day.key];
                        const shift = SHIFTS[shiftKey];
                        
                        newSchedules.push({
                            employee_id: employee.id, // UUID completo
                            week_start: WEEK_START,
                            day_of_week: day.key,
                            start_time: shift.start,
                            end_time: shift.end,
                            hours: shift.hours,
                            is_free_day: shiftKey === 'free',
                            colleagues: [], // Se calcular√° despu√©s si es necesario
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    });
                });

                // Insertar nuevos horarios
                const { data, error } = await supabase
                    .from('schedules')
                    .insert(newSchedules);

                if (error) {
                    console.error('‚ùå Error guardando:', error);
                    alert('Error al guardar horarios: ' + error.message);
                    return;
                }

                console.log('‚úÖ Horarios guardados exitosamente');
                showSaveSuccess();
                updateStatus('Guardado ‚úÖ');

            } catch (error) {
                console.error('‚ùå Error general:', error);
                alert('Error al guardar horarios');
                updateStatus('Error ‚ùå');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function showSaveSuccess() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.classList.remove('hidden');
            
            setTimeout(() => {
                saveStatus.classList.add('hidden');
            }, 3000);
        }

        // ================================
        // INICIALIZACI√ìN
        // ================================

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html> 