<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administraci√≥n Supabase - Forn Verge</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .admin-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .schedule-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .time-input {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            transition: border-color 0.3s ease;
        }
        .time-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .save-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .delete-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .libre-badge {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Header -->
    <header class="admin-header text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-database text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Panel Administraci√≥n Supabase</h1>
                        <p class="text-pink-200">Gesti√≥n de Horarios - Semana 9-15 Febrero 2025</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-pink-200">Estado conexi√≥n</p>
                        <p class="text-sm font-semibold" id="connectionStatus">Conectando...</p>
                    </div>
                    <button id="refreshData" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-6">
        
        <!-- Controles Principales -->
        <div class="bg-white rounded-xl p-6 mb-8 shadow-lg">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Controles Principales</h2>
                    <p class="text-gray-600">Gestiona los horarios de todos los empleados</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="loadAllSchedules" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Cargar Datos
                    </button>
                    <button id="createNewWeek" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nueva Semana
                    </button>
                    <button id="clearAllSchedules" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-trash mr-2"></i>Limpiar Todo
                    </button>
                </div>
            </div>
        </div>

        <!-- Estado de Carga -->
        <div id="loadingState" class="text-center py-12 hidden">
            <div class="loading">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-600">Cargando datos de Supabase...</p>
            </div>
        </div>

        <!-- Grid de Empleados -->
        <div id="employeesGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Se genera din√°micamente -->
        </div>

        <!-- Secci√≥n de Informaci√≥n -->
        <div class="bg-blue-50 rounded-xl p-6 mt-8">
            <h3 class="text-lg font-bold text-blue-800 mb-4">
                <i class="fas fa-info-circle mr-2"></i>Instrucciones de Uso
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-700">
                <div>
                    <h4 class="font-semibold mb-2">üìä Gesti√≥n de Datos</h4>
                    <ul class="space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Cargar Datos:</strong> Obtiene horarios actuales de Supabase</li>
                        <li>‚Ä¢ <strong>Nueva Semana:</strong> Crea horarios vac√≠os para la semana</li>
                        <li>‚Ä¢ <strong>Limpiar Todo:</strong> Elimina todos los horarios de la semana</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">‚úèÔ∏è Edici√≥n de Horarios</h4>
                    <ul class="space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Campos de tiempo:</strong> Formato HH:MM (ej: 08:30)</li>
                        <li>‚Ä¢ <strong>Guardar:</strong> Los cambios se aplican inmediatamente</li>
                        <li>‚Ä¢ <strong>LIBRE:</strong> Deja los campos vac√≠os para d√≠a libre</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n Supabase
        const SUPABASE_URL = 'https://csxgkxjeifakwslamglc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzeGdreGplaWZha3dzbGFtZ2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjM4NjIsImV4cCI6MjA2NDg5OTg2Mn0.iGDmQJGRjsldPGmXLO5PFiaLOk7P3Rpr0omF3b8SJkg';
        const WEEK_START = '2025-02-09';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Configuraci√≥n de empleados
        const EMPLOYEES = [
            { id: 'bryan', name: 'Bryan', emoji: 'üë®‚Äçüç≥' },
            { id: 'raquel', name: 'Raquel', emoji: 'üë©‚Äçüç≥' },
            { id: 'maria', name: 'Mar√≠a', emoji: 'üë©‚Äçüíº' },
            { id: 'xisca', name: 'Xisca', emoji: 'üë©‚Äçüé®' },
            { id: 'andrea', name: 'Andrea', emoji: 'üë©‚Äçüîß' }
        ];

        const DAYS = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        const DAY_NAMES = ['Lunes 9', 'Martes 10', 'Mi√©rcoles 11', 'Jueves 12', 'Viernes 13', 'S√°bado 14', 'Domingo 15'];

        // Variables globales
        let currentSchedules = {};

        // ================================
        // FUNCIONES PRINCIPALES
        // ================================

        async function initializeApp() {
            console.log('üöÄ Inicializando Panel de Administraci√≥n...');
            updateConnectionStatus('Conectado ‚úÖ');
            setupEventListeners();
            await loadAllSchedules();
        }

        function setupEventListeners() {
            document.getElementById('loadAllSchedules').addEventListener('click', loadAllSchedules);
            document.getElementById('createNewWeek').addEventListener('click', createNewWeek);
            document.getElementById('clearAllSchedules').addEventListener('click', clearAllSchedules);
            document.getElementById('refreshData').addEventListener('click', loadAllSchedules);
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('employeesGrid').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('employeesGrid').classList.remove('hidden');
        }

        // ================================
        // GESTI√ìN DE DATOS SUPABASE
        // ================================

        async function loadAllSchedules() {
            showLoading();
            
            try {
                console.log('üìä Cargando horarios desde Supabase...');
                
                const { data, error } = await supabase
                    .from('schedules')
                    .select(`
                        *,
                        employees(name, emoji, employee_id)
                    `)
                    .eq('week_start', WEEK_START)
                    .order('day_of_week')
                    .order('start_time');

                if (error) {
                    console.error('‚ùå Error cargando horarios:', error);
                    updateConnectionStatus('Error de conexi√≥n ‚ùå');
                    renderEmptySchedules();
                    return;
                }

                console.log('‚úÖ Datos obtenidos:', data);
                processScheduleData(data);
                renderEmployeeCards();
                updateConnectionStatus('Datos cargados ‚úÖ');
                
            } catch (error) {
                console.error('‚ùå Error general:', error);
                updateConnectionStatus('Error de conexi√≥n ‚ùå');
                renderEmptySchedules();
            }
            
            hideLoading();
        }

        function processScheduleData(schedules) {
            currentSchedules = {};
            
            // Inicializar empleados vac√≠os
            EMPLOYEES.forEach(emp => {
                currentSchedules[emp.id] = {
                    ...emp,
                    schedule: {}
                };
                
                // Inicializar d√≠as como libres
                DAYS.forEach(day => {
                    currentSchedules[emp.id].schedule[day] = {
                        start_time: '',
                        end_time: '',
                        is_free_day: true
                    };
                });
            });

            // Procesar datos reales
            schedules.forEach(schedule => {
                const empId = schedule.employees?.employee_id || schedule.employee_id;
                
                if (currentSchedules[empId]) {
                    currentSchedules[empId].schedule[schedule.day_of_week] = {
                        start_time: schedule.start_time || '',
                        end_time: schedule.end_time || '',
                        is_free_day: schedule.is_free_day,
                        hours: schedule.hours || 0
                    };
                }
            });

            console.log('üìã Horarios procesados:', currentSchedules);
        }

        function renderEmptySchedules() {
            // Crear estructura vac√≠a si no hay datos
            EMPLOYEES.forEach(emp => {
                currentSchedules[emp.id] = {
                    ...emp,
                    schedule: {}
                };
                
                DAYS.forEach(day => {
                    currentSchedules[emp.id].schedule[day] = {
                        start_time: '',
                        end_time: '',
                        is_free_day: true
                    };
                });
            });
            
            renderEmployeeCards();
        }

        async function createNewWeek() {
            if (!confirm('¬øCrear nueva semana? Esto eliminar√° los horarios actuales.')) {
                return;
            }

            showLoading();
            
            try {
                // Primero eliminar horarios existentes
                await clearAllSchedules(false);
                
                // Crear horarios vac√≠os para todos los empleados
                const newSchedules = [];
                
                EMPLOYEES.forEach(emp => {
                    DAYS.forEach(day => {
                        newSchedules.push({
                            employee_id: emp.id,
                            week_start: WEEK_START,
                            day_of_week: day,
                            start_time: null,
                            end_time: null,
                            is_free_day: true,
                            hours: 0,
                            colleagues: [],
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    });
                });

                const { data, error } = await supabase
                    .from('schedules')
                    .insert(newSchedules);

                if (error) {
                    console.error('‚ùå Error creando nueva semana:', error);
                    alert('Error al crear nueva semana');
                    return;
                }

                console.log('‚úÖ Nueva semana creada');
                alert('Nueva semana creada exitosamente');
                await loadAllSchedules();
                
            } catch (error) {
                console.error('‚ùå Error general:', error);
                alert('Error al crear nueva semana');
            }
            
            hideLoading();
        }

        async function clearAllSchedules(showConfirm = true) {
            if (showConfirm && !confirm('¬øEliminar TODOS los horarios de esta semana?')) {
                return;
            }

            showLoading();
            
            try {
                const { data, error } = await supabase
                    .from('schedules')
                    .delete()
                    .eq('week_start', WEEK_START);

                if (error) {
                    console.error('‚ùå Error eliminando horarios:', error);
                    alert('Error al eliminar horarios');
                    return;
                }

                console.log('‚úÖ Horarios eliminados');
                if (showConfirm) {
                    alert('Todos los horarios eliminados');
                    await loadAllSchedules();
                }
                
            } catch (error) {
                console.error('‚ùå Error general:', error);
                alert('Error al eliminar horarios');
            }
            
            if (showConfirm) {
                hideLoading();
            }
        }

        // ================================
        // RENDERIZADO UI
        // ================================

        function renderEmployeeCards() {
            const grid = document.getElementById('employeesGrid');
            grid.innerHTML = '';

            EMPLOYEES.forEach(emp => {
                const employeeData = currentSchedules[emp.id];
                if (!employeeData) return;

                const card = document.createElement('div');
                card.className = 'schedule-card p-6';
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="text-3xl mr-3">${emp.emoji}</div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${emp.name}</h3>
                            <p class="text-gray-600 text-sm">ID: ${emp.id}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${DAYS.map((day, index) => renderDaySchedule(emp.id, day, DAY_NAMES[index], employeeData.schedule[day])).join('')}
                    </div>
                `;
                
                grid.appendChild(card);
            });

            // Agregar event listeners despu√©s del renderizado
            setupScheduleEventListeners();
        }

        function renderDaySchedule(empId, day, dayName, schedule) {
            const isFree = schedule.is_free_day || (!schedule.start_time && !schedule.end_time);
            
            return `
                <div class="border-l-4 border-blue-400 pl-4 py-2">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-700">${dayName}</h4>
                        ${isFree ? '<span class="libre-badge">LIBRE</span>' : `<span class="text-green-600 font-semibold">${schedule.hours || 0}h</span>`}
                    </div>
                    <div class="flex gap-2 items-center">
                        <input 
                            type="time" 
                            class="time-input flex-1" 
                            value="${schedule.start_time || ''}"
                            data-emp="${empId}"
                            data-day="${day}"
                            data-type="start"
                            placeholder="Inicio"
                        >
                        <span class="text-gray-400">-</span>
                        <input 
                            type="time" 
                            class="time-input flex-1" 
                            value="${schedule.end_time || ''}"
                            data-emp="${empId}"
                            data-day="${day}"
                            data-type="end"
                            placeholder="Fin"
                        >
                        <button 
                            class="save-btn text-white px-3 py-2 rounded text-sm"
                            data-emp="${empId}"
                            data-day="${day}"
                        >
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function setupScheduleEventListeners() {
            // Event listeners para botones guardar
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const empId = e.target.dataset.emp;
                    const day = e.target.dataset.day;
                    await saveScheduleChange(empId, day);
                });
            });

            // Auto-save cuando cambian los inputs
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const empId = e.target.dataset.emp;
                    const day = e.target.dataset.day;
                    
                    // Peque√±o delay para permitir que el usuario termine de editar
                    setTimeout(async () => {
                        await saveScheduleChange(empId, day);
                    }, 1000);
                });
            });
        }

        async function saveScheduleChange(empId, day) {
            const startInput = document.querySelector(`input[data-emp="${empId}"][data-day="${day}"][data-type="start"]`);
            const endInput = document.querySelector(`input[data-emp="${empId}"][data-day="${day}"][data-type="end"]`);
            const saveBtn = document.querySelector(`button[data-emp="${empId}"][data-day="${day}"]`);

            const startTime = startInput.value;
            const endTime = endInput.value;

            // Validar datos
            if ((startTime && !endTime) || (!startTime && endTime)) {
                alert('Debes completar tanto hora de inicio como de fin');
                return;
            }

            // Cambiar estado del bot√≥n
            const originalHTML = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            saveBtn.disabled = true;

            try {
                const isFreDay = !startTime || !endTime;
                const hours = isFreDay ? 0 : calculateHours(startTime, endTime);

                const scheduleData = {
                    employee_id: empId,
                    week_start: WEEK_START,
                    day_of_week: day,
                    start_time: isFreDay ? null : startTime,
                    end_time: isFreDay ? null : endTime,
                    is_free_day: isFreDay,
                    hours: hours,
                    colleagues: [], // Por ahora vac√≠o
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('schedules')
                    .upsert(scheduleData, {
                        onConflict: 'employee_id,week_start,day_of_week'
                    });

                if (error) {
                    console.error('‚ùå Error guardando:', error);
                    alert('Error al guardar cambios');
                    return;
                }

                console.log('‚úÖ Horario guardado:', scheduleData);
                
                // Actualizar estado local
                currentSchedules[empId].schedule[day] = {
                    start_time: startTime,
                    end_time: endTime,
                    is_free_day: isFreDay,
                    hours: hours
                };

                // Feedback visual
                saveBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    saveBtn.classList.remove('bg-green-500');
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error general:', error);
                alert('Error al guardar cambios');
            } finally {
                saveBtn.innerHTML = originalHTML;
                saveBtn.disabled = false;
            }
        }

        function calculateHours(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            const startMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;
            
            const diffMinutes = endMinutes - startMinutes;
            return Math.round((diffMinutes / 60) * 100) / 100; // Redondear a 2 decimales
        }

        // ================================
        // INICIALIZACI√ìN
        // ================================

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html> 