/**
 * N√öCLEO PRINCIPAL DE LA APLICACI√ìN - FORN VERGE
 * ===============================================
 * Inicializaci√≥n y coordinaci√≥n de todos los m√≥dulos
 */

import { initSupabase } from '../config/supabase.js';
import { authManager } from '../config/auth.js';
import { getCurrentWeek } from '../utils/dates.js';
import { updateStatus, showLoading, hideLoading } from '../utils/helpers.js';
import { UIManager } from './ui-manager.js';
import { DataManager } from './data-manager.js';
import { EmployeesModule } from '../modules/employees.js';
import { SchedulesModule } from '../modules/schedules.js';
import { AbsencesModule } from '../modules/absences.js';
import { GeneratorModule } from '../modules/generator.js';
import { ConventionModule } from '../modules/convention.js';

class App {
    constructor() {
        this.isInitialized = false;
        this.currentWeekStart = getCurrentWeek();
        
        // M√≥dulos principales
        this.uiManager = null;
        this.dataManager = null;
        this.employeesModule = null;
        this.schedulesModule = null;
        this.absencesModule = null;
        this.generatorModule = null;
        this.conventionModule = null;
        
        // Estado global
        this.employees = [];
        this.scheduleData = {};
        this.isInDraftMode = false;
        this.originalScheduleBeforeDraft = null;
    }

    /**
     * Inicializa la aplicaci√≥n
     */
    async init() {
        console.log('üöÄ Iniciando Gesti√≥n de Horarios v2...');
        
        try {
            // 1. Inicializar autenticaci√≥n
            authManager.init();
            
            // Si no est√° autenticado, esperar a que se autentique
            if (!authManager.isLoggedIn()) {
                window.addEventListener('authSuccess', () => this.initAfterAuth());
                return;
            }
            
            // Si ya est√° autenticado, inicializar directamente
            await this.initAfterAuth();
            
        } catch (error) {
            console.error('‚ùå Error inicializando la aplicaci√≥n:', error);
            updateStatus('Error de inicializaci√≥n');
        }
    }

    /**
     * Inicializaci√≥n despu√©s de autenticaci√≥n exitosa
     */
    async initAfterAuth() {
        try {
            updateStatus('Inicializando...');
            showLoading();
            
            // 2. Inicializar Supabase
            const supabase = initSupabase();
            if (!supabase) {
                throw new Error('No se pudo inicializar Supabase');
            }
            
            // 3. Inicializar gestores principales
            this.dataManager = new DataManager(supabase);
            this.uiManager = new UIManager();
            
            // 4. Cargar datos iniciales
            await this.loadInitialData();
            
            // 5. Inicializar m√≥dulos
            await this.initModules();
            
            // 6. Configurar interfaz
            this.uiManager.setupWeekNavigation(this.currentWeekStart);
            this.uiManager.setupEventListeners();
            
            // 7. Renderizar vista inicial
            await this.renderInitialView();
            
            this.isInitialized = true;
            hideLoading();
            updateStatus('Listo ‚ú®');
            
            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('‚ùå Error en inicializaci√≥n post-auth:', error);
            updateStatus('Error cargando datos');
            hideLoading();
        }
    }

    /**
     * Carga los datos iniciales necesarios
     */
    async loadInitialData() {
        console.log('üìä Cargando datos iniciales...');
        
        // Cargar empleados
        this.employees = await this.dataManager.loadEmployees();
        console.log(`üë• ${this.employees.length} empleados cargados`);
        
        // Cargar horarios de la semana actual
        this.scheduleData = await this.dataManager.loadSchedules(this.currentWeekStart);
        console.log(`üìÖ Horarios cargados para semana ${this.currentWeekStart}`);
    }

    /**
     * Inicializa todos los m√≥dulos
     */
    async initModules() {
        console.log('üîß Inicializando m√≥dulos...');
        
        // M√≥dulo de empleados
        this.employeesModule = new EmployeesModule(this.dataManager);
        await this.employeesModule.init();
        
        // M√≥dulo de horarios
        this.schedulesModule = new SchedulesModule(this.dataManager);
        await this.schedulesModule.init();
        
        // M√≥dulo de ausencias
        this.absencesModule = new AbsencesModule(this.dataManager);
        await this.absencesModule.init();
        
        // M√≥dulo de convenio
        this.conventionModule = new ConventionModule(this.dataManager);
        await this.conventionModule.init();
        
        // M√≥dulo generador (depende de los otros)
        this.generatorModule = new GeneratorModule(
            this.dataManager,
            this.absencesModule,
            this.conventionModule
        );
        await this.generatorModule.init();
        
        // Hacer m√≥dulos disponibles globalmente para compatibilidad
        window.app = this;
        window.employeesModule = this.employeesModule;
        window.schedulesModule = this.schedulesModule;
        window.absencesManager = this.absencesModule; // Compatibilidad con nombre antiguo
        window.controlAnualSimple = this.conventionModule; // Compatibilidad con nombre antiguo
    }

    /**
     * Renderiza la vista inicial
     */
    async renderInitialView() {
        console.log('üé® Renderizando vista inicial...');
        
        // Renderizar empleados y horarios
        this.uiManager.renderEmployees(this.employees, this.scheduleData);
        
        // Actualizar contador de horas
        this.uiManager.updateHoursCounter(this.employees, this.scheduleData);
        
        // Configurar vista por defecto
        this.uiManager.initDefaultView();
    }

    /**
     * Cambia a una semana diferente
     * @param {string} newWeekStart - Nueva semana en formato YYYY-MM-DD
     */
    async changeWeek(newWeekStart) {
        if (newWeekStart === this.currentWeekStart) return;
        
        try {
            updateStatus('Cargando semana...');
            showLoading();
            
            // Guardar semana actual
            this.currentWeekStart = newWeekStart;
            localStorage.setItem('fornverge_last_week', newWeekStart);
            
            // Recargar datos para la nueva semana
            this.scheduleData = await this.dataManager.loadSchedules(newWeekStart);
            
            // Actualizar UI
            this.uiManager.updateWeekDisplay(newWeekStart);
            this.uiManager.renderEmployees(this.employees, this.scheduleData);
            this.uiManager.updateHoursCounter(this.employees, this.scheduleData);
            
            // Limpiar modo borrador si estaba activo
            if (this.isInDraftMode) {
                this.discardDraft();
            }
            
            hideLoading();
            updateStatus('Listo ‚ú®');
            
        } catch (error) {
            console.error('‚ùå Error cambiando de semana:', error);
            updateStatus('Error cargando semana');
            hideLoading();
        }
    }

    /**
     * Activa el modo borrador
     * @param {Object} draftScheduleData - Datos del borrador
     */
    enableDraftMode(draftScheduleData) {
        // Guardar estado original
        this.originalScheduleBeforeDraft = JSON.parse(JSON.stringify(this.scheduleData));
        
        // Aplicar borrador
        this.scheduleData = draftScheduleData;
        this.isInDraftMode = true;
        
        // Actualizar UI
        this.uiManager.showDraftMode();
        this.uiManager.renderEmployees(this.employees, this.scheduleData);
        this.uiManager.updateHoursCounter(this.employees, this.scheduleData);
    }

    /**
     * Guarda el borrador actual
     */
    async saveDraft() {
        if (!this.isInDraftMode) return;
        
        try {
            updateStatus('Guardando horario...');
            
            await this.dataManager.saveSchedules(this.currentWeekStart, this.scheduleData);
            
            // Limpiar modo borrador
            this.originalScheduleBeforeDraft = null;
            this.isInDraftMode = false;
            this.uiManager.hideDraftMode();
            
            updateStatus('Horario guardado ‚úÖ');
            
        } catch (error) {
            console.error('‚ùå Error guardando borrador:', error);
            updateStatus('Error guardando');
        }
    }

    /**
     * Descarta el borrador actual
     */
    discardDraft() {
        if (!this.isInDraftMode) return;
        
        // Restaurar estado original
        if (this.originalScheduleBeforeDraft) {
            this.scheduleData = this.originalScheduleBeforeDraft;
            this.originalScheduleBeforeDraft = null;
        }
        
        this.isInDraftMode = false;
        this.uiManager.hideDraftMode();
        
        // Re-renderizar
        this.uiManager.renderEmployees(this.employees, this.scheduleData);
        this.uiManager.updateHoursCounter(this.employees, this.scheduleData);
    }

    /**
     * Recarga los datos de empleados
     */
    async reloadEmployees() {
        this.employees = await this.dataManager.loadEmployees();
        this.uiManager.renderEmployees(this.employees, this.scheduleData);
        this.uiManager.updateHoursCounter(this.employees, this.scheduleData);
    }

    /**
     * Recarga los horarios de la semana actual
     */
    async reloadSchedules() {
        this.scheduleData = await this.dataManager.loadSchedules(this.currentWeekStart);
        this.uiManager.renderEmployees(this.employees, this.scheduleData);
        this.uiManager.updateHoursCounter(this.employees, this.scheduleData);
    }

    /**
     * Cierra sesi√≥n
     */
    logout() {
        authManager.logout();
        location.reload();
    }
}

// Instancia √∫nica de la aplicaci√≥n
export const app = new App();

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    app.init();
});
