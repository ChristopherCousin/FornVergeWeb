<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Supabase - Forn Verge</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Monaco', 'Courier New', monospace; }
        .debug-header { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); }
        .json-viewer {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.4;
        }
        .table-info {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .error { color: #ef4444; font-weight: bold; }
        .success { color: #10b981; font-weight: bold; }
        .info { color: #3b82f6; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Header -->
    <header class="debug-header text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-bug text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Debug Supabase</h1>
                        <p class="text-blue-200">Diagn√≥stico de Base de Datos</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-200">Estado</p>
                    <p class="text-sm font-semibold" id="status">Listo</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-6">
        
        <!-- Controles -->
        <div class="table-info">
            <h2 class="text-xl font-bold mb-4">üîç Controles de Diagn√≥stico</h2>
            <div class="flex flex-wrap gap-2">
                <button class="btn" onclick="checkConnection()">
                    <i class="fas fa-wifi mr-2"></i>Probar Conexi√≥n
                </button>
                <button class="btn" onclick="inspectEmployees()">
                    <i class="fas fa-users mr-2"></i>Ver Empleados
                </button>
                <button class="btn" onclick="inspectSchedules()">
                    <i class="fas fa-calendar mr-2"></i>Ver Horarios
                </button>
                <button class="btn" onclick="inspectAllWeeks()">
                    <i class="fas fa-clock mr-2"></i>Todas las Semanas
                </button>
                <button class="btn" onclick="inspectTableStructure()">
                    <i class="fas fa-database mr-2"></i>Estructura Tablas
                </button>
                <button class="btn" onclick="clearConsole()">
                    <i class="fas fa-eraser mr-2"></i>Limpiar
                </button>
            </div>
        </div>

        <!-- Resultados -->
        <div class="table-info">
            <h2 class="text-xl font-bold mb-4">üìä Resultados</h2>
            <div id="results" class="json-viewer">
üîç Haz click en los botones para inspeccionar la base de datos...
            </div>
        </div>

        <!-- Info de Configuraci√≥n -->
        <div class="table-info">
            <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Configuraci√≥n Actual</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h3 class="font-semibold mb-2">üóÑÔ∏è Base de Datos</h3>
                    <ul class="space-y-1">
                        <li><strong>URL:</strong> https://csxgkxjeifakwslamglc.supabase.co</li>
                        <li><strong>Semana Actual:</strong> 2025-02-09</li>
                        <li><strong>Tablas Esperadas:</strong> employees, schedules</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">üë• Empleados Esperados</h3>
                    <ul class="space-y-1">
                        <li>‚Ä¢ bryan (üë®‚Äçüç≥ Bryan)</li>
                        <li>‚Ä¢ raquel (üë©‚Äçüç≥ Raquel)</li>
                        <li>‚Ä¢ maria (üë©‚Äçüíº Mar√≠a)</li>
                        <li>‚Ä¢ xisca (üë©‚Äçüé® Xisca)</li>
                        <li>‚Ä¢ andrea (üë©‚Äçüîß Andrea)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n
        const SUPABASE_URL = 'https://csxgkxjeifakwslamglc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzeGdreGplaWZha3dzbGFtZ2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjM4NjIsImV4cCI6MjA2NDg5OTg2Mn0.iGDmQJGRjsldPGmXLO5PFiaLOk7P3Rpr0omF3b8SJkg';
        const WEEK_START = '2025-02-09';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Utilidades
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }

        function logObject(title, obj) {
            log(`\n=== ${title} ===`);
            log(JSON.stringify(obj, null, 2));
            log(`=== Fin ${title} ===\n`);
        }

        function clearConsole() {
            document.getElementById('results').innerHTML = 'üîç Console limpiado...\n';
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        // ================================
        // FUNCIONES DE DIAGN√ìSTICO
        // ================================

        async function checkConnection() {
            log('üåê Probando conexi√≥n a Supabase...', 'info');
            updateStatus('Conectando...');
            
            try {
                // Probar una query simple
                const { data, error, status, statusText } = await supabase
                    .from('employees')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    logObject('Error completo', error);
                    updateStatus('Error');
                    return;
                }

                log('‚úÖ Conexi√≥n exitosa', 'success');
                log(`üìä Status HTTP: ${status} ${statusText}`);
                updateStatus('Conectado');
                
            } catch (error) {
                log(`‚ùå Error de red: ${error.message}`, 'error');
                logObject('Error completo', error);
                updateStatus('Error de red');
            }
        }

        async function inspectEmployees() {
            log('üë• Inspeccionando tabla employees...', 'info');
            updateStatus('Cargando empleados...');
            
            try {
                // Obtener todos los empleados
                const { data, error, count } = await supabase
                    .from('employees')
                    .select('*', { count: 'exact' });

                if (error) {
                    log(`‚ùå Error obteniendo empleados: ${error.message}`, 'error');
                    logObject('Error empleados', error);
                    updateStatus('Error');
                    return;
                }

                log(`‚úÖ Empleados encontrados: ${count || data?.length || 0}`, 'success');
                
                if (data && data.length > 0) {
                    logObject('DATOS EMPLEADOS', data);
                    
                    // Mostrar estructura de campos
                    log('\nüìã Campos disponibles en employees:');
                    const fields = Object.keys(data[0]);
                    fields.forEach(field => {
                        const value = data[0][field];
                        const type = typeof value;
                        log(`  ‚Ä¢ ${field}: ${type} (ejemplo: ${JSON.stringify(value)})`);
                    });
                } else {
                    log('‚ö†Ô∏è No hay empleados en la tabla', 'error');
                }
                
                updateStatus('Listo');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
                logObject('Error completo', error);
                updateStatus('Error');
            }
        }

        async function inspectSchedules() {
            log(`üìÖ Inspeccionando horarios para semana ${WEEK_START}...`, 'info');
            updateStatus('Cargando horarios...');
            
            try {
                // Obtener horarios de la semana actual
                const { data, error, count } = await supabase
                    .from('schedules')
                    .select('*', { count: 'exact' })
                    .eq('week_start', WEEK_START);

                if (error) {
                    log(`‚ùå Error obteniendo horarios: ${error.message}`, 'error');
                    logObject('Error horarios', error);
                    updateStatus('Error');
                    return;
                }

                log(`‚úÖ Horarios encontrados para ${WEEK_START}: ${count || data?.length || 0}`, 'success');
                
                if (data && data.length > 0) {
                    logObject('DATOS HORARIOS ACTUALES', data);
                    
                    // Mostrar estructura de campos
                    log('\nüìã Campos disponibles en schedules:');
                    const fields = Object.keys(data[0]);
                    fields.forEach(field => {
                        const value = data[0][field];
                        const type = typeof value;
                        log(`  ‚Ä¢ ${field}: ${type} (ejemplo: ${JSON.stringify(value)})`);
                    });
                } else {
                    log('‚ö†Ô∏è No hay horarios para esta semana', 'error');
                }
                
                updateStatus('Listo');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
                logObject('Error completo', error);
                updateStatus('Error');
            }
        }

        async function inspectAllWeeks() {
            log('üìÜ Inspeccionando todas las semanas disponibles...', 'info');
            updateStatus('Buscando semanas...');
            
            try {
                // Obtener todas las semanas √∫nicas
                const { data, error } = await supabase
                    .from('schedules')
                    .select('week_start')
                    .order('week_start');

                if (error) {
                    log(`‚ùå Error obteniendo semanas: ${error.message}`, 'error');
                    logObject('Error semanas', error);
                    updateStatus('Error');
                    return;
                }

                if (data && data.length > 0) {
                    const uniqueWeeks = [...new Set(data.map(item => item.week_start))];
                    log(`‚úÖ Semanas encontradas: ${uniqueWeeks.length}`, 'success');
                    
                    uniqueWeeks.forEach(week => {
                        log(`  üìÖ ${week}`);
                    });
                    
                    // Contar horarios por semana
                    log('\nüìä Horarios por semana:');
                    for (const week of uniqueWeeks) {
                        const { count } = await supabase
                            .from('schedules')
                            .select('*', { count: 'exact', head: true })
                            .eq('week_start', week);
                        
                        log(`  ${week}: ${count} horarios`);
                    }
                } else {
                    log('‚ö†Ô∏è No hay horarios en ninguna semana', 'error');
                }
                
                updateStatus('Listo');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
                logObject('Error completo', error);
                updateStatus('Error');
            }
        }

        async function inspectTableStructure() {
            log('üèóÔ∏è Inspeccionando estructura de tablas...', 'info');
            updateStatus('Analizando estructura...');
            
            try {
                // Intentar obtener un registro de cada tabla para ver la estructura
                const tables = [
                    { name: 'employees', query: supabase.from('employees').select('*').limit(1) },
                    { name: 'schedules', query: supabase.from('schedules').select('*').limit(1) }
                ];

                for (const table of tables) {
                    log(`\nüîç Analizando tabla: ${table.name}`);
                    
                    try {
                        const { data, error } = await table.query;
                        
                        if (error) {
                            log(`‚ùå Error en tabla ${table.name}: ${error.message}`, 'error');
                            continue;
                        }
                        
                        if (data && data.length > 0) {
                            log(`‚úÖ Tabla ${table.name} - Estructura:`, 'success');
                            const sample = data[0];
                            Object.keys(sample).forEach(field => {
                                const value = sample[field];
                                const type = typeof value;
                                const isNull = value === null;
                                log(`  ‚Ä¢ ${field}: ${type}${isNull ? ' (null)' : ''} = ${JSON.stringify(value)}`);
                            });
                        } else {
                            log(`‚ö†Ô∏è Tabla ${table.name} est√° vac√≠a`);
                        }
                        
                    } catch (tableError) {
                        log(`‚ùå Error accediendo a tabla ${table.name}: ${tableError.message}`, 'error');
                    }
                }
                
                updateStatus('Listo');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
                logObject('Error completo', error);
                updateStatus('Error');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Panel de Debug cargado', 'success');
            log('Haz click en los botones para inspeccionar la base de datos');
        });
    </script>
</body>
</html> 