<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descongelaci√≥n Diaria - Forn Verge de Lluc</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .admin-header { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); }
        
        .day-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 24px;
        }
        
        .today-card {
            border: 3px solid #10b981;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
        }
        
        .product-row {
            border-bottom: 1px solid #f3f4f6;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
        }
        
        .product-row:last-child {
            border-bottom: none;
        }
        
        .product-name {
            font-weight: 600;
            color: #374151;
        }
        
        .product-quantity {
            font-weight: 700;
            color: #1f2937;
            font-size: 18px;
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 8px;
            min-width: 80px;
            text-align: center;
        }
        
        .day-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }
        
        .today-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            animation: pulse-subtle 2s infinite;
        }
        
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        .total-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
        }
        
        .today-card {
            border: 3px solid #f59e0b;
            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.3);
            transform: scale(1.02);
            margin-bottom: 32px;
        }
        
        .urgente-badge {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 800;
            animation: parpadeo 1s infinite;
        }
        
        @keyframes parpadeo {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }
        
        .completed {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .product-checkbox {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .progress-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .tiempo-restante {
            color: #ef4444;
            font-weight: 700;
            font-size: 14px;
        }
        
        .critical-product {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        
        .producto-alto {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-left: 4px solid #f97316;
        }
        
        @media (max-width: 768px) {
            .product-name { font-size: 18px; }
            .product-quantity { font-size: 20px; padding: 10px 18px; }
            .today-header h2 { font-size: 1.8rem; }
        }
        
        .solo-hoy-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Header -->
    <header class="admin-header text-white p-6 shadow-xl">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-snowflake text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">Descongelaci√≥n Diaria</h1>
                        <p class="text-blue-200">Cantidades por d√≠a - Forn Verge de Lluc</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold" id="currentDate"></div>
                    <div class="text-blue-200" id="currentTime"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Instrucciones -->
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-2xl p-6 mb-8 shadow-lg">
            <div class="flex items-center space-x-4 mb-4">
                <i class="fas fa-info-circle text-2xl text-blue-600"></i>
                <h2 class="text-xl font-bold text-gray-800">Instrucciones</h2>
            </div>
            <div class="grid md:grid-cols-3 gap-4 text-gray-700">
                <div class="text-center">
                    <i class="fas fa-clock text-xl mb-2 text-orange-500"></i>
                    <h3 class="font-bold mb-1">Horario</h3>
                    <p class="text-sm">Descongelar antes de las 7:00 AM</p>
                </div>
                <div class="text-center">
                    <i class="fas fa-thermometer-half text-xl mb-2 text-blue-500"></i>
                    <h3 class="font-bold mb-1">Temperatura</h3>
                    <p class="text-sm">C√°mara de descongelaci√≥n a 4¬∞C</p>
                </div>
                <div class="text-center">
                    <i class="fas fa-check-circle text-xl mb-2 text-green-500"></i>
                    <h3 class="font-bold mb-1">Control</h3>
                    <p class="text-sm">Marcar como completado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="max-w-4xl mx-auto px-6 mb-4">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-4">
                <div id="tiempoRestante" class="tiempo-restante"></div>
                <div id="progressoHoy" class="hidden">
                    <div class="text-sm text-gray-600 mb-1">Progreso del d√≠a</div>
                    <div class="progress-bar w-48">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <button id="soloHoyBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                Solo Hoy
            </button>
        </div>
        
        <!-- Filtros por Tanda -->
        <div class="bg-white rounded-xl p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-gray-800 mb-2">Horarios de Preparaci√≥n:</h3>
                <div class="flex space-x-2">
                    <button onclick="filtrarPorTanda('ma√±ana')" class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-orange-200">
                        üåÖ Ma√±ana (6:00-11:00)
                    </button>
                    <button onclick="filtrarPorTanda('mediodia')" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-yellow-200">
                        ‚òÄÔ∏è Mediod√≠a (11:00-17:00)
                    </button>
                    <button onclick="filtrarPorTanda('tarde')" class="bg-purple-100 text-purple-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-purple-200">
                        üåÜ Tarde (17:00-21:00)
                    </button>
                    <button onclick="mostrarTodasLasTandas()" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-gray-200">
                        üìã Todas
                    </button>
                </div>
            </div>
            <div class="text-sm text-gray-600 mt-2">
                <span class="font-semibold">üî• Cr√≠ticos:</span> Barra Cl√°sica, Mini Croissant ‚Ä¢ 
                <span class="font-semibold">üìã Panes:</span> Se hacen en tandas ‚Ä¢ 
                <span class="font-semibold">ü•ê Boller√≠a:</span> Solo ma√±ana (6:00-11:00)
            </div>
        </div>
    </div>

    <!-- D√≠as de la Semana -->
    <div class="max-w-4xl mx-auto p-6" id="daysContainer">
        <!-- Se genera din√°micamente -->
    </div>
    
    <!-- Bot√≥n flotante -->
    <button id="todosLosDiasBtn" class="solo-hoy-btn hidden" onclick="mostrarTodosLosDias()">
        <i class="fas fa-calendar-week mr-2"></i>Ver Todos los D√≠as
    </button>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // üîß CONFIGURACI√ìN SUPABASE (mismo que admin.html)
        const SUPABASE_URL = 'https://csxgkxjeifakwslamglc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzeGdreGplaWZha3dzbGFtZ2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzMjM4NjIsImV4cCI6MjA2NDg5OTg2Mn0.iGDmQJGRjsldPGmXLO5PFiaLOk7P3Rpr0omF3b8SJkg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // üîß PRODUCTOS POR TANDAS (7:00-21:00)
        const PRODUCTOS_TANDAS = {
            // PANES - Se hacen en tandas durante todo el d√≠a
            'Barra Campesina': { 
                monday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                tuesday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                wednesday: { ma√±ana: 4, mediodia: 2, tarde: 2 }, 
                thursday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                friday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                saturday: { ma√±ana: 2, mediodia: 2, tarde: 1 }, 
                sunday: { ma√±ana: 8, mediodia: 6, tarde: 5 },
                categoria: 'pan', tipo: 'tandas'
            },
            'Barra Cl√°sica': { 
                monday: { ma√±ana: 35, mediodia: 25, tarde: 22 }, 
                tuesday: { ma√±ana: 30, mediodia: 22, tarde: 17 }, 
                wednesday: { ma√±ana: 32, mediodia: 26, tarde: 20 }, 
                thursday: { ma√±ana: 28, mediodia: 20, tarde: 15 }, 
                friday: { ma√±ana: 28, mediodia: 20, tarde: 15 }, 
                saturday: { ma√±ana: 32, mediodia: 24, tarde: 18 }, 
                sunday: { ma√±ana: 65, mediodia: 48, tarde: 38 },
                categoria: 'pan', tipo: 'tandas', critico: true
            },
            'Barra Panier': { 
                monday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                tuesday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                wednesday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                thursday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                friday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                saturday: { ma√±ana: 1, mediodia: 1, tarde: 1 }, 
                sunday: { ma√±ana: 8, mediodia: 6, tarde: 4 },
                categoria: 'pan', tipo: 'tandas'
            },
            'Barra Picos': { 
                monday: { ma√±ana: 3, mediodia: 1, tarde: 1 }, 
                tuesday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                wednesday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                thursday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                friday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                saturday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                sunday: { ma√±ana: 5, mediodia: 4, tarde: 2 },
                categoria: 'pan', tipo: 'tandas'
            },
            'Flauta': { 
                monday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                tuesday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                wednesday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                thursday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                friday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                saturday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                sunday: { ma√±ana: 3, mediodia: 2, tarde: 2 },
                categoria: 'pan', tipo: 'tandas'
            },
            'Pan Moreno 500 g': { 
                monday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                tuesday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                wednesday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                thursday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                friday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                saturday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                sunday: { ma√±ana: 4, mediodia: 3, tarde: 3 },
                categoria: 'pan', tipo: 'tandas'
            },
            'Pan Moreno 700 g': { 
                monday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                tuesday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                wednesday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                thursday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                friday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                saturday: { ma√±ana: 2, mediodia: 1, tarde: 1 }, 
                sunday: { ma√±ana: 4, mediodia: 3, tarde: 3 },
                categoria: 'pan', tipo: 'tandas'
            },

            // BOLLER√çA PREMIUM - Tandas para producto siempre fresco üî•
            'Croissant (incluye desayunos)': { 
                monday: { ma√±ana: 15, mediodia: 8, tarde: 3 }, 
                tuesday: { ma√±ana: 16, mediodia: 8, tarde: 4 }, 
                wednesday: { ma√±ana: 18, mediodia: 10, tarde: 4 }, 
                thursday: { ma√±ana: 12, mediodia: 7, tarde: 3 }, 
                friday: { ma√±ana: 15, mediodia: 8, tarde: 4 }, 
                saturday: { ma√±ana: 24, mediodia: 12, tarde: 6 }, 
                sunday: { ma√±ana: 26, mediodia: 14, tarde: 6 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium', critico: true
            },
            'Mini Croissant (incluye desayunos)': { 
                monday: { ma√±ana: 20, mediodia: 12, tarde: 4 }, 
                tuesday: { ma√±ana: 23, mediodia: 13, tarde: 5 }, 
                wednesday: { ma√±ana: 30, mediodia: 16, tarde: 8 }, 
                thursday: { ma√±ana: 16, mediodia: 9, tarde: 4 }, 
                friday: { ma√±ana: 28, mediodia: 15, tarde: 7 }, 
                saturday: { ma√±ana: 36, mediodia: 20, tarde: 9 }, 
                sunday: { ma√±ana: 38, mediodia: 22, tarde: 8 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium', critico: true
            },
            'Mini Croissant Choco D√∫o': { 
                monday: { ma√±ana: 5, mediodia: 3, tarde: 1 }, 
                tuesday: { ma√±ana: 6, mediodia: 4, tarde: 1 }, 
                wednesday: { ma√±ana: 8, mediodia: 5, tarde: 2 }, 
                thursday: { ma√±ana: 6, mediodia: 3, tarde: 1 }, 
                friday: { ma√±ana: 4, mediodia: 2, tarde: 1 }, 
                saturday: { ma√±ana: 9, mediodia: 6, tarde: 2 }, 
                sunday: { ma√±ana: 10, mediodia: 6, tarde: 2 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium'
            },
            'Napolitana Choco.': { 
                monday: { ma√±ana: 5, mediodia: 3, tarde: 1 }, 
                tuesday: { ma√±ana: 4, mediodia: 2, tarde: 1 }, 
                wednesday: { ma√±ana: 6, mediodia: 4, tarde: 1 }, 
                thursday: { ma√±ana: 5, mediodia: 3, tarde: 1 }, 
                friday: { ma√±ana: 5, mediodia: 3, tarde: 1 }, 
                saturday: { ma√±ana: 7, mediodia: 4, tarde: 1 }, 
                sunday: { ma√±ana: 7, mediodia: 4, tarde: 2 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium'
            },
            'Napolitana Jam√≥n/Queso': { 
                monday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                tuesday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                wednesday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                thursday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                friday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                saturday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                sunday: { ma√±ana: 3, mediodia: 2, tarde: 1 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium'
            },
            'Ensaimada 60 g': { 
                monday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                tuesday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                wednesday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                thursday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                friday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                saturday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                sunday: { ma√±ana: 4, mediodia: 3, tarde: 1 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium'
            },
            'Ensaimada Crema 60 g': { 
                monday: { ma√±ana: 4, mediodia: 3, tarde: 1 }, 
                tuesday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                wednesday: { ma√±ana: 2, mediodia: 2, tarde: 0 }, 
                thursday: { ma√±ana: 1, mediodia: 1, tarde: 0 }, 
                friday: { ma√±ana: 2, mediodia: 1, tarde: 0 }, 
                saturday: { ma√±ana: 3, mediodia: 2, tarde: 1 }, 
                sunday: { ma√±ana: 10, mediodia: 6, tarde: 3 },
                categoria: 'bolleria', tipo: 'tres_tandas_premium'
            },

            // EMPANADAS - Se preparan en dos tandas (ma√±ana y mediod√≠a)
            'Empanada Carne': { 
                monday: { ma√±ana: 3, mediodia: 3 }, tuesday: { ma√±ana: 4, mediodia: 4 }, wednesday: { ma√±ana: 5, mediodia: 4 }, 
                thursday: { ma√±ana: 2, mediodia: 2 }, friday: { ma√±ana: 3, mediodia: 3 }, saturday: { ma√±ana: 3, mediodia: 2 }, sunday: { ma√±ana: 4, mediodia: 4 },
                categoria: 'empanada', tipo: 'dos_tandas'
            },
            'Empanada Guisantes': { 
                monday: { ma√±ana: 3, mediodia: 2 }, tuesday: { ma√±ana: 3, mediodia: 2 }, wednesday: { ma√±ana: 5, mediodia: 4 }, 
                thursday: { ma√±ana: 4, mediodia: 3 }, friday: { ma√±ana: 3, mediodia: 3 }, saturday: { ma√±ana: 3, mediodia: 3 }, sunday: { ma√±ana: 5, mediodia: 5 },
                categoria: 'empanada', tipo: 'dos_tandas'
            },
            'Empanada Pollo y Cebolla': { 
                monday: { ma√±ana: 4, mediodia: 3 }, tuesday: { ma√±ana: 4, mediodia: 4 }, wednesday: { ma√±ana: 5, mediodia: 4 }, 
                thursday: { ma√±ana: 4, mediodia: 3 }, friday: { ma√±ana: 4, mediodia: 4 }, saturday: { ma√±ana: 4, mediodia: 4 }, sunday: { ma√±ana: 6, mediodia: 5 },
                categoria: 'empanada', tipo: 'dos_tandas'
            }
        };

        const DIAS = [
            { key: 'monday', name: 'Lunes', emoji: 'üìã' },
            { key: 'tuesday', name: 'Martes', emoji: 'üìã' },
            { key: 'wednesday', name: 'Mi√©rcoles', emoji: 'üìã' },
            { key: 'thursday', name: 'Jueves', emoji: 'üìã' },
            { key: 'friday', name: 'Viernes', emoji: 'üìã' },
            { key: 'saturday', name: 'S√°bado', emoji: 'üõçÔ∏è' },
            { key: 'sunday', name: 'Domingo', emoji: 'üò¥' }
        ];

        let soloHoyMode = false;
        let filtroTandaActual = null;
        let productosCompletados = new Set();

        // üîß MEJORA 4: D√≠a actual prioritario
        function getDiaActual() {
            const hoy = new Date();
            const diasSemana = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            return diasSemana[hoy.getDay()];
        }

        // üîß MEJORA 5-7: Fecha, hora y tiempo restante
        function actualizarFechaHora() {
            const ahora = new Date();
            document.getElementById('currentDate').textContent = ahora.toLocaleDateString('es-ES', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('currentTime').textContent = ahora.toLocaleTimeString('es-ES');
            
            // Calcular tiempo hasta las 7:00 AM
            const tiempoRestante = calcularTiempoRestante();
            document.getElementById('tiempoRestante').innerHTML = tiempoRestante;
        }

        // üîß MEJORA 8: Horarios de preparaci√≥n seg√∫n el momento del d√≠a
        function obtenerHorarioActual() {
            const ahora = new Date();
            const hora = ahora.getHours();
            
            if (hora >= 6 && hora < 11) return 'ma√±ana';
            if (hora >= 11 && hora < 17) return 'mediodia';
            if (hora >= 17 && hora < 21) return 'tarde';
            return 'cerrado';
        }
        
        function calcularTiempoRestante() {
            const ahora = new Date();
            const horarioActual = obtenerHorarioActual();
            
            let siguienteTanda = '';
            let proximoHorario = new Date();
            
            switch(horarioActual) {
                case 'ma√±ana':
                    siguienteTanda = 'mediod√≠a';
                    proximoHorario.setHours(11, 0, 0, 0);
                    break;
                case 'mediodia':
                    siguienteTanda = 'tarde';
                    proximoHorario.setHours(17, 0, 0, 0);
                    break;
                case 'tarde':
                    siguienteTanda = 'ma√±ana (ma√±ana)';
                    proximoHorario.setDate(proximoHorario.getDate() + 1);
                    proximoHorario.setHours(6, 0, 0, 0);
                    break;
                case 'cerrado':
                    if (ahora.getHours() < 6) {
                        siguienteTanda = 'ma√±ana';
                        proximoHorario.setHours(6, 0, 0, 0);
                    } else {
                        siguienteTanda = 'ma√±ana (ma√±ana)';
                        proximoHorario.setDate(proximoHorario.getDate() + 1);
                        proximoHorario.setHours(6, 0, 0, 0);
                    }
                    break;
            }
            
            if (horarioActual === 'cerrado') {
                return '<span style="color: #6b7280;">üåô Cerrado - Pr√≥xima preparaci√≥n: ' + siguienteTanda + '</span>';
            }
            
            const diff = proximoHorario - ahora;
            if (diff <= 0) {
                return '<span style="color: #10b981;">‚úÖ Horario actual: ' + horarioActual.toUpperCase() + '</span>';
            }
            
            const horas = Math.floor(diff / (1000 * 60 * 60));
            const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (horas === 0 && minutos < 30) {
                return `<span class="urgente-badge">üö® Pr√≥xima tanda en ${minutos}min</span>`;
            }
            
            return `‚è∞ Pr√≥xima tanda (${siguienteTanda}): ${horas}h ${minutos}min`;
        }

        // üîß MEJORA 9-10: Productos del d√≠a por tandas + Ordenaci√≥n inteligente
        function obtenerProductosDelDia(dia, tandaEspecifica = null) {
            const productos = [];
            let totalUnidades = 0;
            const horarioActual = obtenerHorarioActual();
            
            Object.entries(PRODUCTOS_TANDAS).forEach(([nombre, data]) => {
                const tandaDia = data[dia];
                let tandas = [];
                
                // Determinar qu√© tandas mostrar seg√∫n el horario
                if (tandaEspecifica) {
                    // Mostrar tanda espec√≠fica
                    if (tandaDia[tandaEspecifica]) {
                        tandas.push({
                            tanda: tandaEspecifica,
                            cantidad: tandaDia[tandaEspecifica]
                        });
                    }
                } else {
                    // Mostrar tandas seg√∫n el horario actual
                    if (data.tipo === 'ma√±ana_temprano') {
                        // Solo preparar por la ma√±ana temprano
                        if (tandaDia.ma√±ana) {
                            tandas.push({
                                tanda: 'ma√±ana',
                                cantidad: tandaDia.ma√±ana,
                                urgente: horarioActual === 'ma√±ana'
                            });
                        }
                    } else if (data.tipo === 'dos_tandas') {
                        // Preparar ma√±ana y mediod√≠a
                        if (tandaDia.ma√±ana) {
                            tandas.push({
                                tanda: 'ma√±ana',
                                cantidad: tandaDia.ma√±ana,
                                urgente: horarioActual === 'ma√±ana'
                            });
                        }
                        if (tandaDia.mediodia) {
                            tandas.push({
                                tanda: 'mediod√≠a',
                                cantidad: tandaDia.mediodia,
                                urgente: horarioActual === 'mediodia'
                            });
                        }
                    } else if (data.tipo === 'tandas') {
                        // Preparar en las tres tandas
                        ['ma√±ana', 'mediodia', 'tarde'].forEach(tanda => {
                            if (tandaDia[tanda] && tandaDia[tanda] > 0) {
                                tandas.push({
                                    tanda: tanda === 'mediodia' ? 'mediod√≠a' : tanda,
                                    cantidad: tandaDia[tanda],
                                    urgente: horarioActual === tanda
                                });
                            }
                        });
                    }
                }
                
                if (tandas.length > 0) {
                    productos.push({ 
                        nombre, 
                        tandas,
                        totalCantidad: tandas.reduce((sum, t) => sum + t.cantidad, 0),
                        critico: data.critico,
                        alto: data.alto,
                        categoria: data.categoria,
                        tipo: data.tipo
                    });
                    totalUnidades += tandas.reduce((sum, t) => sum + t.cantidad, 0);
                }
            });
            
            // Ordenar: cr√≠ticos primero, luego por cantidad total descendente
            productos.sort((a, b) => {
                if (a.critico && !b.critico) return -1;
                if (!a.critico && b.critico) return 1;
                return b.totalCantidad - a.totalCantidad;
            });
            
            return { productos, totalUnidades };
        }

        // üîß MEJORA 11: Checkbox para marcar completados por tandas + GUARDAR EN SUPABASE
        async function toggleProducto(dia, productoNombre, tanda) {
            const key = `${dia}-${productoNombre}-${tanda}`;
            const ahora = new Date().toISOString();
            const hoyFecha = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            if (productosCompletados.has(key)) {
                // Desmarcar
                productosCompletados.delete(key);
                
                // Eliminar de Supabase
                await supabase
                    .from('descongelacion_completados')
                    .delete()
                    .eq('fecha', hoyFecha)
                    .eq('producto', productoNombre)
                    .eq('tanda', tanda);
                    
            } else {
                // Marcar como completado
                productosCompletados.add(key);
                
                // Guardar en Supabase
                await supabase
                    .from('descongelacion_completados')
                    .upsert({
                        fecha: hoyFecha,
                        dia_semana: dia,
                        producto: productoNombre,
                        tanda: tanda,
                        completado_at: ahora,
                        completado: true
                    });
                
                // Vibraci√≥n en m√≥viles
                if (navigator.vibrate) navigator.vibrate(50);
            }
            
            actualizarProgreso(dia);
        }

        // üîß MEJORA 12: Barra de progreso por tandas
        function actualizarProgreso(dia) {
            const diaActual = getDiaActual();
            if (dia === diaActual) {
                const dataDia = obtenerProductosDelDia(dia);
                
                // Contar total de tandas
                let totalTandas = 0;
                let completadas = 0;
                
                dataDia.productos.forEach(producto => {
                    producto.tandas.forEach(tanda => {
                        totalTandas++;
                        const key = `${dia}-${producto.nombre}-${tanda.tanda}`;
                        if (productosCompletados.has(key)) {
                            completadas++;
                        }
                    });
                });
                
                const porcentaje = totalTandas > 0 ? (completadas / totalTandas) * 100 : 0;
                document.getElementById('progressFill').style.width = `${porcentaje}%`;
                document.getElementById('progressoHoy').classList.remove('hidden');
                
                // Sonido al completar todo (si es compatible)
                if (porcentaje === 100 && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('¬°Todas las tandas completadas!');
                    utterance.rate = 0.8;
                    utterance.volume = 0.3;
                    speechSynthesis.speak(utterance);
                }
            }
        }

        // üîß MEJORA 13-14: Solo hoy + Todos los d√≠as
        function mostrarSoloHoy() {
            soloHoyMode = true;
            document.getElementById('soloHoyBtn').classList.add('hidden');
            document.getElementById('todosLosDiasBtn').classList.remove('hidden');
            generarVistaPorDias();
        }

        function mostrarTodosLosDias() {
            soloHoyMode = false;
            document.getElementById('soloHoyBtn').classList.remove('hidden');
            document.getElementById('todosLosDiasBtn').classList.add('hidden');
            generarVistaPorDias();
        }

        // üîß MEJORA 15-20: Vista inteligente con 20+ mejoras
        function generarVistaPorDias() {
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';
            const diaActual = getDiaActual();
            
            // Reordenar: d√≠a actual primero, luego el resto
            let diasAMostrar = [...DIAS];
            if (!soloHoyMode) {
                const hoyIndex = diasAMostrar.findIndex(d => d.key === diaActual);
                if (hoyIndex > -1) {
                    const hoy = diasAMostrar.splice(hoyIndex, 1)[0];
                    diasAMostrar.unshift(hoy);
                }
            } else {
                diasAMostrar = diasAMostrar.filter(d => d.key === diaActual);
            }
            
            diasAMostrar.forEach((dia, index) => {
                const esHoy = dia.key === diaActual;
                const dataDia = obtenerProductosDelDia(dia.key, filtroTandaActual);
                
                const dayCard = document.createElement('div');
                dayCard.className = `day-card ${esHoy ? 'today-card' : ''}`;
                dayCard.id = `dia-${dia.key}`;
                
                const productsHtml = dataDia.productos.map(producto => {
                    let extraClass = '';
                    if (producto.critico) extraClass = 'critical-product';
                    else if (producto.alto) extraClass = 'producto-alto';
                    
                    // Crear filas para cada tanda
                    return producto.tandas.map(tanda => {
                        const key = `${dia.key}-${producto.nombre}-${tanda.tanda}`;
                        const completado = productosCompletados.has(key);
                        
                        let tandaIcon = '';
                        let tandaColor = '';
                        switch(tanda.tanda) {
                            case 'ma√±ana':
                                tandaIcon = 'üåÖ';
                                tandaColor = tanda.urgente ? 'bg-orange-100 border-orange-300' : '';
                                break;
                            case 'mediod√≠a':
                                tandaIcon = '‚òÄÔ∏è';
                                tandaColor = tanda.urgente ? 'bg-yellow-100 border-yellow-300' : '';
                                break;
                            case 'tarde':
                                tandaIcon = 'üåÜ';
                                tandaColor = tanda.urgente ? 'bg-purple-100 border-purple-300' : '';
                                break;
                        }
                        
                        return `
                            <div class="product-row ${extraClass} ${tandaColor} ${completado ? 'completed' : ''}">
                                <div class="flex items-center flex-1">
                                    <input type="checkbox" 
                                           class="product-checkbox" 
                                           ${completado ? 'checked' : ''}
                                           onchange="toggleProducto('${dia.key}', '${producto.nombre}', '${tanda.tanda}')">
                                    <span class="product-name">
                                        ${producto.critico ? 'üî• ' : ''}${producto.alto ? '‚ö° ' : ''}${producto.nombre}
                                        <span class="text-sm text-gray-500 ml-2">${tandaIcon} ${tanda.tanda}</span>
                                        ${tanda.urgente ? '<span class="urgente-badge ml-2">¬°AHORA!</span>' : ''}
                                    </span>
                                </div>
                                <span class="product-quantity">${tanda.cantidad} uds</span>
                            </div>
                        `;
                    }).join('');
                }).join('');
                
                const urgenteBadge = esHoy && new Date().getHours() >= 6 ? 
                    '<div class="urgente-badge">üö® ¬°URGENTE!</div>' : '';
                
                dayCard.innerHTML = `
                    <div class="${esHoy ? 'today-header' : 'day-header'}">
                        <div class="flex items-center justify-center space-x-3">
                            <span class="text-2xl">${dia.emoji}</span>
                            <div>
                                <h2 class="text-2xl font-bold">
                                    ${dia.name}${esHoy ? ' - HOY' : ''}
                                </h2>
                                <div class="total-badge">
                                    Total: ${dataDia.totalUnidades} unidades
                                </div>
                                ${urgenteBadge}
                            </div>
                        </div>
                    </div>
                    <div>
                        ${productsHtml}
                    </div>
                `;
                
                container.appendChild(dayCard);
                
                // Auto-scroll al d√≠a actual (solo la primera vez)
                if (esHoy && index === 0 && !soloHoyMode) {
                    setTimeout(() => dayCard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                }
            });
            
            // Actualizar progreso del d√≠a actual
            actualizarProgreso(diaActual);
        }

        // üîß CARGAR DATOS DE SUPABASE
        async function cargarDatosGuardados() {
            try {
                const hoyFecha = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('descongelacion_completados')
                    .select('*')
                    .eq('fecha', hoyFecha)
                    .eq('completado', true);
                
                if (error) throw error;
                
                // Cargar en el Set local
                productosCompletados.clear();
                data.forEach(item => {
                    const key = `${item.dia_semana}-${item.producto}-${item.tanda}`;
                    productosCompletados.add(key);
                });
                
                generarVistaPorDias();
                console.log('‚úÖ Datos cargados desde Supabase:', data.length, 'items');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                // Fallback a localStorage
                const saved = localStorage.getItem('descongelacion-completados');
                if (saved) {
                    productosCompletados = new Set(JSON.parse(saved));
                    generarVistaPorDias();
                }
            }
        }

        // üîß MEJORA 21: Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            actualizarFechaHora();
            
            // Cargar datos guardados de Supabase
            await cargarDatosGuardados();
            
            // Bot√≥n Solo Hoy
            document.getElementById('soloHoyBtn').addEventListener('click', mostrarSoloHoy);
            
            // Actualizar cada minuto
            setInterval(actualizarFechaHora, 60000);
            
            // Backup en localStorage cada 30 segundos
            setInterval(() => {
                localStorage.setItem('descongelacion-completados', 
                    JSON.stringify([...productosCompletados]));
            }, 30000);
        });

        // üîß MEJORA 22: Funci√≥n para resetear d√≠a
        function resetearDia() {
            const diaActual = getDiaActual();
            productosCompletados.forEach(key => {
                if (key.startsWith(diaActual + '-')) {
                    productosCompletados.delete(key);
                }
            });
            generarVistaPorDias();
        }

        // üîß MEJORA 23-26: Filtros por tandas
        function filtrarPorTanda(tanda) {
            filtroTandaActual = tanda;
            generarVistaPorDias();
        }

        function mostrarTodasLasTandas() {
            filtroTandaActual = null;
            generarVistaPorDias();
        }
    </script>
</body>
</html> 